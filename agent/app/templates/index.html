<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vault AI Agent</title>
  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light;
    }
    body {
      margin: 2rem auto;
      max-width: 900px;
      padding: 0 1.5rem;
      color: #1f2933;
      background: #f8fafc;
    }
    h1 {
      color: #102a43;
      margin-bottom: 0.5rem;
    }
    textarea {
      width: 100%;
      min-height: 140px;
      padding: 0.75rem;
      border-radius: 10px;
      border: 1px solid #cbd2d9;
      font-size: 1rem;
      font-family: inherit;
      resize: vertical;
      margin-bottom: 1rem;
      background: #ffffff;
    }
    button {
      padding: 0.6rem 1.6rem;
      font-size: 1rem;
      border-radius: 999px;
      border: none;
      background: #334e68;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    button:hover {
      background: #243b53;
    }
    #response {
      margin-top: 1.5rem;
      padding: 1.25rem;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.75rem;
      border-bottom: 1px solid #e4e7eb;
      text-align: left;
    }
    th {
      background: #f1f5f9;
      color: #102a43;
    }
    .keywords {
      margin-top: 1rem;
      color: #486581;
    }
    .error {
      color: #b91c1c;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <h1>Vault AI Agent</h1>
  <p>Enter a prompt and the agent will fetch data from Postgres using credentials retrieved from Vault KV.</p>
  <textarea id="prompt" placeholder="Ask about automation solutions..."></textarea>
  <br />
  <button onclick="sendPrompt()">Ask Agent</button>
  <h2>Response</h2>
  <div id="response">(awaiting prompt)</div>

  <script>
    async function sendPrompt() {
      const prompt = document.getElementById('prompt').value.trim();
      const output = document.getElementById('response');
      if (!prompt) {
        output.innerHTML = '<p class="error">Please enter a prompt.</p>';
        return;
      }
      output.innerHTML = '<em>Processingâ€¦</em>';
      try {
        const res = await fetch('/api/v1/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: prompt })
        });
        let data;
        if (!res.ok) {
          try {
            data = await res.json();
            output.innerHTML = `<p class="error">Error ${res.status}: ${JSON.stringify(data)}</p>`;
          } catch (jsonErr) {
            const text = await res.text();
            output.innerHTML = `<p class="error">Error ${res.status}: ${text}</p>`;
          }
          return;
        }
        try {
          data = await res.json();
        } catch (jsonErr) {
          const text = await res.text();
          output.innerHTML = `<p class="error">Unexpected response: ${text}</p>`;
          return;
        }
        renderResponse(data, output);
      } catch (err) {
        output.innerHTML = `<p class="error">Network error: ${err}</p>`;
      }
    }

    function renderResponse(data, output) {
      const { answer, products = [], keywords = [] } = data;
      const productsHtml = products.length
        ? `
          <table>
            <thead>
              <tr>
                <th>Product</th>
                <th>Description</th>
                <th>Contact</th>
                <th>Use cases</th>
              </tr>
            </thead>
            <tbody>
              ${products.map((item) => `
                <tr>
                  <td>${item.product_name}</td>
                  <td>${item.description}</td>
                  <td>${item.owner_name} (${item.owner_email})</td>
                  <td>${(item.recommended_use_cases || []).join(", ") || "n/a"}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        `
        : '<p>No catalogued products matched this request.</p>';

      const keywordsHtml = keywords.length
        ? `<strong>Extracted keywords:</strong> ${keywords.join(", ")}`
        : '<strong>Extracted keywords:</strong> n/a';

      output.innerHTML = `
        <section class="agent-answer">
          ${answer}
        </section>
        <section class="agent-details">
          <h3>Matched products</h3>
          ${productsHtml}
          <div class="keywords">${keywordsHtml}</div>
        </section>
      `;
    }
  </script>
</body>
</html>
